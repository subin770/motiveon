<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="Work-Mapper">

  <!-- ================== 공통 resultMap ================== -->
  <resultMap id="workMap" type="com.motiveon.dto.WorkVO">
    <id property="wcode" column="WCODE" />
    <result property="wtitle" column="WTITLE" />
    <result property="wdate" column="WDATE" />
    <result property="wend" column="WEND" />
    <result property="wopen" column="WOPEN" />
    <result property="walarm" column="WALARM" />
    <result property="eno" column="ENO" />
    <result property="wstatus" column="WSTATUS" />   <!-- ✅ 컬럼명 맞춤 -->
    <result property="dno" column="DNO" />
    <result property="wcontent" column="WCONTENT" />
    <result property="requesterEno" column="REQUESTER_ENO" />
    <result property="managerEno" column="MANAGER_ENO" />
    <!-- 요청자/담당자 이름 -->
    <result property="requesterName" column="REQUESTERNAME" />
    <result property="managerName" column="MANAGERNAME" />
  </resultMap>

  <!-- 목록 조회용 (간략 DTO) -->
  <resultMap id="workListMap" type="com.motiveon.dto.WorkListDTO">
    <id property="wcode" column="WCODE"/>
    <result property="wtitle" column="WTITLE"/>
    <result property="wdate" column="WDATE"/>
    <result property="wend" column="WEND"/>
    <result property="wstatus" column="WSTATUS"/>
    <result property="eno" column="ENO"/>
    <result property="dno" column="DNO"/>
    <result property="answer" column="ANSWER"/>
    <!-- 요청자/담당자 -->
    <result property="requesterEno" column="REQUESTER_ENO"/>
    <result property="requesterName" column="REQUESTERNAME"/>
    <result property="managerEno" column="MANAGER_ENO"/>
    <result property="managerName" column="MANAGERNAME"/>
  </resultMap>

  <!-- 댓글/이의신청 -->
  <resultMap id="workReplyMap" type="com.motiveon.dto.WorkReplyVO">
    <id property="wrno" column="WRNO" />
    <result property="wcode" column="WCODE" />
    <result property="eno" column="ENO" />
    <result property="wrcontent" column="WRCONTENT" />
    <result property="wrregdate" column="WRREGDATE" />
    <result property="writerName" column="WRITERNAME" />
  </resultMap>

  <resultMap id="workManagerMap" type="com.motiveon.dto.WorkManagerVO">
    <id property="wmstep" column="WMSTEP" />
    <result property="wcode" column="WCODE" />
    <result property="eno" column="ENO" />
    <result property="isAfter" column="ISAFTER" />
    <result property="answer" column="ANSWER" />
  </resultMap>

  <!-- ================== 시퀀스 ================== -->
  <select id="getNextWcode" resultType="string">
    SELECT 'W' || LPAD(WORK_SEQ.NEXTVAL, 5, '0') FROM dual
  </select>

  <!-- ================== 등록 ================== -->
  <insert id="insertWork" parameterType="com.motiveon.dto.WorkVO">
   INSERT INTO WORK (
  WCODE, WTITLE, WDATE, WEND, ENO, DNO, REQUESTER_ENO, MANAGER_ENO, WSTATUS
)
VALUES (
  #{wcode}, #{wtitle}, SYSDATE, #{wend}, #{eno}, #{dno},
  #{requesterEno}, #{managerEno},
  NVL(#{wstatus}, '대기')
)
  </insert>

  <!-- ================== 상세 ================== -->
  <select id="selectWorkDetail" parameterType="string" resultMap="workMap">
    SELECT 
      W.*, 
      E1.ENAME AS REQUESTERNAME,
      E2.ENAME AS MANAGERNAME
    FROM WORK W
      LEFT JOIN EMPLOYEE E1 ON W.REQUESTER_ENO = E1.ENO
      LEFT JOIN EMPLOYEE E2 ON W.MANAGER_ENO = E2.ENO
    WHERE W.WCODE = #{wcode}
  </select>

  <!-- ================== 상태 변경 ================== -->
  <update id="updateApproval" parameterType="map">
    UPDATE WORK SET WSTATUS = 'ING' WHERE WCODE = #{wcode}
  </update>

  <update id="updateWorkStatus" parameterType="map">
    UPDATE WORK SET WSTATUS = #{status} WHERE WCODE = #{wcode}
  </update>
  
  <!-- 담당자 답변 상태 업데이트 -->
  <update id="updateManagerAnswer" parameterType="map">
    UPDATE WORKMANAGER SET ANSWER = #{answer}
    WHERE WCODE = #{wcode} AND ENO = #{eno}
  </update>

  <!-- ================== 목록 조회 ================== -->
  <select id="selectMyList" resultMap="workListMap" parameterType="map">
    SELECT WCODE, WTITLE, WDATE, WEND, WSTATUS, ENO, DNO
    FROM WORK
    WHERE ENO = #{eno}
       OR REQUESTER_ENO = #{eno}
  </select>

  <select id="selectMyWorkList" parameterType="int" resultType="com.motiveon.dto.WorkListDTO">
    SELECT 
        w.wcode,
        w.wtitle,
        w.wstatus,
        w.wdate      AS wdate,        -- DTO 필드명에 맞춤
        w.wend       AS wend,         -- 마감일
        w.manager_eno AS managerEno,  -- DTO 필드명에 맞춤
        w.requester_eno AS requesterEno
    FROM work w
    WHERE w.manager_eno = #{value}
       OR w.requester_eno = #{value}
    ORDER BY w.wdate DESC
</select>
  
  <select id="selectWorkList" resultMap="workListMap">
    SELECT 
      W.WCODE, 
      W.WTITLE,
      W.WDATE,
      W.WEND,
      W.WSTATUS,
      W.REQUESTER_ENO,
      W.MANAGER_ENO,
      E1.ENAME AS REQUESTERNAME,
      E2.ENAME AS MANAGERNAME
    FROM WORK W
      LEFT JOIN EMPLOYEE E1 ON W.REQUESTER_ENO = E1.ENO
      LEFT JOIN EMPLOYEE E2 ON W.MANAGER_ENO = E2.ENO
  </select>
  
  <!-- 내가 요청한 업무 -->
  <select id="selectToReqList" parameterType="int" resultType="com.motiveon.dto.WorkListDTO">
    SELECT 
      w.wcode,
      w.wtitle,
      w.wstatus,
      w.wdate      AS wdate,
      w.wend       AS wend,          <!-- ✅ 마감일 추가 -->
      w.manager_eno AS managerEno,
      w.requester_eno AS requesterEno
    FROM work w
    WHERE w.requester_eno = #{value}
    ORDER BY w.wdate DESC
</select>

  <update id="updateWork" parameterType="com.motiveon.dto.WorkVO">
    UPDATE WORK
    SET WTITLE = #{wtitle},
        WEND = #{wend},
        WSTATUS = #{wstatus},
        WCONTENT = #{wcontent}
    WHERE WCODE = #{wcode}
  </update>

  <!-- ================== 이의신청/댓글 ================== -->
  <select id="selectObjectionList" resultMap="workReplyMap">
    SELECT R.WRNO, R.WCODE, R.ENO, R.WRCONTENT, R.WRREGDATE,
           E.ENAME AS WRITERNAME
    FROM WORKREPLY R
      JOIN EMPLOYEE E ON R.ENO = E.ENO
    WHERE R.WCODE = #{wcode}
    ORDER BY R.WRREGDATE DESC
  </select>

  <select id="selectObjectionByWrno" resultMap="workReplyMap">
    SELECT R.WRNO, R.WCODE, R.ENO, R.WRCONTENT, R.WRREGDATE,
           E.ENAME AS WRITERNAME
    FROM WORKREPLY R
      JOIN EMPLOYEE E ON R.ENO = E.ENO
    WHERE R.WRNO = #{wrno}
  </select>

  <insert id="insertObjection" parameterType="com.motiveon.dto.WorkReplyVO">
    INSERT INTO WORKREPLY (WRNO, WCODE, ENO, WRCONTENT, WRREGDATE)
    VALUES (WORKREPLY_SEQ.NEXTVAL, #{wcode}, #{eno}, #{wrcontent}, SYSDATE)
  </insert>

  <select id="selectDepWorkList" resultMap="workListMap" parameterType="int">
    SELECT W.WCODE, W.WTITLE, W.WDATE, W.WEND, W.WSTATUS, W.ENO, W.DNO,
           R.ENAME AS REQUESTERNAME,
           M.ENAME AS MANAGERNAME
    FROM WORK W
      LEFT JOIN EMPLOYEE R ON W.REQUESTER_ENO = R.ENO
      LEFT JOIN EMPLOYEE M ON W.MANAGER_ENO = M.ENO
    WHERE DNO = #{dno}
  </select>

  <!-- 담당자 목록 -->
  <select id="selectWorkManagersByWcode" parameterType="string" resultType="com.motiveon.dto.WorkManagerVO">
    SELECT WM.WCODE, WM.ENO, E.ENAME
    FROM WORKMANAGER WM
      JOIN EMPLOYEE E ON WM.ENO = E.ENO
    WHERE WM.WCODE = #{wcode}
  </select>

  <select id="selectPendingApprovalList" parameterType="int" resultMap="workListMap">
    SELECT WCODE, WTITLE, WDATE, WEND, WSTATUS, ENO, DNO
    FROM WORK
    WHERE ENO = #{eno}
      AND WSTATUS = 'PENDING'
  </select>

  <select id="selectWaitingRequestedList" parameterType="int" resultMap="workListMap">
    SELECT WCODE, WTITLE, WDATE, WEND, WSTATUS, ENO, DNO
    FROM WORK
    WHERE ENO = #{eno}
      AND WSTATUS = 'WAITING'
  </select>

  <select id="selectWeeklyRequestedList" parameterType="int" resultMap="workListMap">
    SELECT WCODE, WTITLE, WDATE, WEND, WSTATUS, ENO, DNO
    FROM WORK
    WHERE ENO = #{eno}
      AND WDATE BETWEEN TRUNC(SYSDATE, 'IW') AND TRUNC(SYSDATE, 'IW')+6
  </select>

  <select id="selectWeeklyClosingList" parameterType="int" resultType="com.motiveon.dto.WorkVO">
    SELECT WCODE, WTITLE, WDATE, WEND, WSTATUS, ENO, DNO
    FROM WORK
    WHERE ENO = #{eno}
  </select>

</mapper>
